
<div th:replace="~{includes/backend-config :: backend-config}"></div>

<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ajouter une Borne - Electricity Business</title>
<link rel="stylesheet" th:href="@{/css/common-styles.css?v=20251022v5}">
<meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob:; connect-src 'self' http://localhost:8080 https://electricity-business-backend-jvc9.onrender.com https://nominatim.openstreetmap.org; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com data:;">
</head>
<body>
    <div class="header">
        <h1>Electricity Business</h1>
        <div class="user-info">
            <span id="welcomeMessage">Bienvenue</span>
            <a href="#" onclick="logout(); return false;">Déconnexion</a>
        </div>
    </div>
    
    <nav class="navigation">
        <a th:href="@{/dashboard}" class="nav-link">Tableau de bord</a>
        <a th:href="@{/add-location}" class="nav-link">Ajouter un lieu</a>
        <a th:href="@{/locations}" class="nav-link">Mes lieux</a>
        <a th:href="@{/add-station}" class="nav-link active">Ajouter une borne</a>
        <a th:href="@{/stations}" class="nav-link">Mes bornes</a>
        <a th:href="@{/add-reservation}" class="nav-link">Réserver</a>
        <a th:href="@{/reservations}" class="nav-link">Mes réservations</a>
        <a th:href="@{/map}" class="nav-link">Carte des bornes</a>
    </nav>

<div class="container">
  <h2>Ajouter une borne</h2>

  <div class="row">
    <label for="name">Nom</label>
    <input id="name" type="text" placeholder="Ex: Borne Maison" required>
  </div>

  <div class="row">
    <label for="locationId">Lieu</label>
    <select id="locationId" required></select>
  </div>

  <div class="row">
    <label for="power">Puissance (kW)</label>
    <input id="power" type="number" step="0.1" value="7.4">
  </div>

  <div class="row">
    <label for="city">Ville</label>
    <input id="city" type="text" placeholder="Ex: Paris">
  </div>

  <div class="row">
    <label><input id="customPosition" type="checkbox"> Position spécifique à la borne</label>
  </div>

  <div id="latitudeRow" class="row" style="display:none;">
    <label for="latitude">Latitude</label>
    <input id="latitude" type="number" step="0.000001" placeholder="48.8566">
  </div>

  <div id="longitudeRow" class="row" style="display:none;">
    <label for="longitude">Longitude</label>
    <input id="longitude" type="number" step="0.000001" placeholder="2.3522">
  </div>

  <div class="row">
    <label for="instructions">Instructions</label>
    <textarea id="instructions" rows="3" placeholder="Infos d'accès, badge, etc."></textarea>
  </div>

  <div class="row">
    <label><input id="onFoot" type="checkbox"> Sur pied</label>
  </div>

  <div class="row">
    <button id="submitBtn">Ajouter</button>
    <button id="geoBtn" class="secondary" type="button">Utiliser ma position</button>
  </div>

  <div id="msg" class="msg"></div>
</div>

<!-- Scripts -->
<script th:src="@{/js/config.js}"></script>
<script th:src="@{/js/jwt-utils.js}"></script>
<script th:src="@{/js/nominatim-utils.js}"></script>
<script>
  // Vérifier l'authentification
  if (!requireAuth()) {
    // L'utilisateur sera redirigé automatiquement par requireAuth()
  } else {
  
  // Récupérer l'ID de l'utilisateur depuis le token JWT
  const CURRENT_USER_ID = getCurrentUserId();

  document.addEventListener('DOMContentLoaded', () => {
    loadLocations();
    document.getElementById('submitBtn').addEventListener('click', onSubmit);
    document.getElementById('geoBtn').addEventListener('click', useGeolocation);
    const custom = document.getElementById('customPosition');
    custom.addEventListener('change', () => {
      const show = custom.checked;
      document.getElementById('latitudeRow').style.display = show ? '' : 'none';
      document.getElementById('longitudeRow').style.display = show ? '' : 'none';
      if (!show) {
        document.getElementById('latitude').value = '';
        document.getElementById('longitude').value = '';
      }
    });
  });

  async function loadLocations() {
    try {
      const res = await authenticatedFetch(API_BASE_URL + '/api/locations/owner/' + CURRENT_USER_ID + '/active');
      if (!res.ok) throw new Error('Erreur chargement lieux');
      const data = await res.json();
      const locations = Array.isArray(data) ? data : (data.content || []);
      const select = document.getElementById('locationId');
      select.innerHTML = '<option value="">Choisir…</option>';
      for (const loc of locations) {
        // Afficher tous les lieux (le backend vérifie la propriété lors de la création)
        const opt = document.createElement('option');
        opt.value = String(loc.id);
        const lat = loc.latitude != null ? Number(loc.latitude).toFixed(6) : '?';
        const lng = loc.longitude != null ? Number(loc.longitude).toFixed(6) : '?';
        opt.textContent = (loc.label || 'Lieu') + ` (lat:${lat}, lng:${lng})`;
        select.appendChild(opt);
      }
      select.addEventListener('change', () => {
        const sel = select.value;
        const found = locations.find(l => String(l.id) === sel);
        if (found) {
          // Si position spécifique non cochée, masquer les champs
          const custom = document.getElementById('customPosition').checked;
          if (!custom) {
            document.getElementById('latitude').value = '';
            document.getElementById('longitude').value = '';
          }
        }
      });
    } catch (e) {
      showMsg('Erreur lors du chargement des lieux', true);
    }
  }

  async function onSubmit(e) {
    e.preventDefault();
    const name = document.getElementById('name').value.trim();
    const locationIdStr = document.getElementById('locationId').value;
    if (!name || !locationIdStr) {
      showMsg('Nom et Lieu sont obligatoires', true);
      return;
    }

    const custom = document.getElementById('customPosition').checked;
    const payload = {
      name: name + ' - ' + Date.now(),
      locationId: parseInt(locationIdStr, 10),
      power: parseFloat(document.getElementById('power').value) || null,
      city: document.getElementById('city').value || null,
      latitude: custom ? toNum(document.getElementById('latitude').value) : null,
      longitude: custom ? toNum(document.getElementById('longitude').value) : null,
      instructions: document.getElementById('instructions').value || null,
      onFoot: document.getElementById('onFoot').checked,
      plugType: 'TYPE_2S',
      hourlyRate: 2.0
    };
    
    try {
      const res = await authenticatedFetch(API_BASE_URL + '/api/stations', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        const txt = await res.text();
        if (res.status === 400) {
          if (txt && txt.includes("n'appartient pas au propriétaire")) {
            showMsg('Le lieu sélectionné n\'appartient pas à votre compte.', true);
            return;
          }
          if (txt && txt.includes('existe déjà')) {
            showMsg('Une borne avec ce nom existe déjà. Réessayez avec un autre nom.', true);
            return;
          }
          showMsg('Création impossible (400). Vérifiez que le lieu vous appartient et que le nom est unique.', true);
          return;
        }
        showMsg('Création impossible (' + res.status + '). ' + (txt || 'Vérifiez les champs.'), true);
        return;
      }

      showMsg('Borne créée avec succès.', false);
      setTimeout(() => { window.location.href = '/stations'; }, 1200);
    } catch (e) {
      showMsg('Erreur réseau. Veuillez réessayer.', true);
    }
  }

  function toNum(v) {
    const n = parseFloat(v);
    return Number.isFinite(n) ? n : null;
  }

  async function useGeolocation() {
    showMsg('Détection de la position...', false);
    
    try {
      // Utiliser la fonction améliorée avec Nominatim
      const location = await getAccurateLocation();
      
      // Cocher automatiquement la case "Position spécifique"
      document.getElementById('customPosition').checked = true;
      document.getElementById('latitudeRow').style.display = '';
      document.getElementById('longitudeRow').style.display = '';
      
      // Remplir les champs
      document.getElementById('latitude').value = location.latitude.toFixed(6);
      document.getElementById('longitude').value = location.longitude.toFixed(6);
      
      // Remplir aussi la ville si disponible
      if (location.city && !document.getElementById('city').value) {
        document.getElementById('city').value = location.city;
      }
      
      // Message avec source et précision
      let successMsg = 'Position détectée !';
      if (location.source === 'IP Address') {
        successMsg += ' (approximative - basée sur IP)';
      } else {
        successMsg += ' Précision: ' + Math.round(location.accuracy) + 'm';
      }
      if (location.city) {
        successMsg += ' - Ville: ' + location.city;
      }
      
      showMsg(successMsg, false);
      
    } catch (error) {
      showMsg('Erreur: ' + error.message, true);
    }
  }

  function showMsg(text, isError) {
    const el = document.getElementById('msg');
    el.textContent = text;
    el.className = 'msg ' + (isError ? 'err' : 'ok');
    el.style.display = 'block';
  }
  
  } // Fermer le bloc else
</script>
<script th:src="@{/js/auth.js}"></script>
</body>
</html>
