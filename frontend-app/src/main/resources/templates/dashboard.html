<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:replace="~{includes/navbar :: head-bootstrap}"></th:block>
    <title>Tableau de bord - Electricity Business</title>
    
    <style>
        /* Styles sp√©cifiques pour composants custom uniquement */
        .filter-bar { 
            display: flex; 
            gap: 1rem; 
            align-items: center;
            padding: 1rem;
            background-color: var(--bs-gray-100);
            border-radius: var(--bs-border-radius);
            border: 1px solid var(--bs-border-color);
        }
        .filter-bar label { 
            font-size: 0.875rem; 
            color: var(--bs-body-color); 
            font-weight: 500; 
            margin-bottom: 0;
        }
        .filter-bar input { 
            font-size: 0.875rem;
        }
        .locations-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
            gap: 1.25rem; 
        }
        .location-card { 
            border: 1px solid var(--bs-border-color);
            border-radius: var(--bs-border-radius);
        }
        .location-card .station { 
            background-color: var(--bs-gray-100); 
            padding: 0.625rem; 
            margin: 0.5rem 0; 
            border-radius: var(--bs-border-radius-sm);
            border: 1px solid var(--bs-border-color-translucent);
        }
        .location-card .station-name { 
            font-weight: 600; 
            color: var(--bs-body-color); 
            font-size: 0.875rem; 
        }
        .location-card .station-rate { 
            color: var(--bs-secondary-color); 
            font-size: 0.75rem; 
        }
        .location-actions { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 0.5rem; 
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--bs-border-color);
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .filter-bar {
                flex-direction: column;
                align-items: stretch;
            }
            .filter-bar input {
                width: 100%;
            }
            .locations-grid {
                grid-template-columns: 1fr;
            }
            .location-actions {
                flex-direction: column;
            }
            .location-actions .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div th:replace="~{includes/backend-config :: backend-config}"></div>
    
    <!-- Navbar Bootstrap -->
    <div th:replace="~{includes/navbar :: navbar}"></div>
    
    <div class="container my-4">
        <!-- Message container -->
        <div id="messageContainer"></div>
        
        <!-- Mes r√©servations en cours -->
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-white border-bottom">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 text-primary">Mes r√©servations en cours</h5>
                    <a th:href="@{/add-reservation}" class="btn btn-primary btn-sm">
                        <i class="bi bi-plus-circle me-1"></i> Nouvelle r√©servation
                    </a>
                </div>
            </div>
            <div class="card-body">
            <div id="currentReservationsLoading" class="loading">Chargement...</div>
            <div id="currentReservationsContainer" style="display: none;">
                <div class="table-responsive">
                <table class="table table-hover" id="currentReservationsTable">
                    <thead class="table-light">
                        <tr>
                            <th>Date et heure d√©but</th>
                            <th>Date et heure fin</th>
                            <th>Utilisateur</th>
                            <th>Borne, Lieu, Ville</th>
                            <th>Montant r√©gl√©</th>
                            <th>Statut</th>
                            <th>Actions / Re√ßu</th>
                        </tr>
                    </thead>
                    <tbody id="currentReservationsBody"></tbody>
                </table>
                </div>
                <div id="currentReservationsEmpty" class="text-center py-5 text-muted" style="display: none;">
                    <p class="mb-0">Aucune r√©servation en cours</p>
                </div>
            </div>
        </div>
        </div>
            
        <!-- Mes r√©servations pass√©es -->
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-white border-bottom">
                <h5 class="mb-0 text-primary">Mes r√©servations pass√©es</h5>
            </div>
            <div class="card-body">
            <div class="filter-bar">
                <label class="form-label mb-0">Date d√©but :</label>
                <input type="date" id="filterDateStart" class="form-control form-control-sm">
                <label class="form-label mb-0">Date fin :</label>
                <input type="date" id="filterDateEnd" class="form-control form-control-sm">
                <button class="btn btn-primary btn-sm" onclick="filterPastReservations()">
                    <i class="bi bi-funnel me-1"></i>Filtrer
                </button>
                <button class="btn btn-outline-secondary btn-sm" onclick="resetPastFilter()">
                    <i class="bi bi-arrow-counterclockwise me-1"></i>R√©initialiser
                </button>
            </div>
            <div id="pastReservationsLoading" class="loading">Chargement...</div>
            <div id="pastReservationsContainer" style="display: none;">
                <div class="table-responsive">
                <table class="table table-hover" id="pastReservationsTable">
                    <thead class="table-light">
                        <tr>
                            <th>Date et heure d√©but</th>
                            <th>Date et heure fin</th>
                            <th>Utilisateur</th>
                            <th>Borne, Lieu, Ville</th>
                            <th>Montant r√©gl√©</th>
                            <th>Statut</th>
                            <th>Re√ßu</th>
                        </tr>
                    </thead>
                    <tbody id="pastReservationsBody"></tbody>
                </table>
                </div>
                <div id="pastReservationsEmpty" class="text-center py-5 text-muted" style="display: none;">
                    <p class="mb-0">Aucune r√©servation pass√©e</p>
                </div>
                <div id="pastPagination" class="d-flex justify-content-center mt-3"></div>
                <div class="d-flex justify-content-end mt-3">
                    <a href="#" onclick="exportToExcel(); return false;" class="btn btn-success btn-sm">
                        <i class="bi bi-file-earmark-excel me-1"></i> Exporter Excel
                    </a>
                </div>
            </div>
        </div>
        </div>
            
        <!-- Lieux de recharge -->
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-white border-bottom">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 text-primary">Lieux de recharge</h5>
                    <button class="btn btn-primary btn-sm" onclick="window.location.href='/add-location'">
                        <i class="bi bi-plus-circle me-1"></i> Ajouter un lieu
                    </button>
                </div>
            </div>
            <div class="card-body">
            <div id="locationsLoading" class="loading">Chargement...</div>
            <div id="locationsContainer" style="display: none;">
                <div class="locations-grid" id="locationsGrid"></div>
                <div id="locationsEmpty" class="text-center py-5 text-muted" style="display: none;">
                    <p class="mb-0">Aucun lieu de recharge</p>
                </div>
            </div>
        </div>
        </div>
            
        <!-- Demandes de r√©servations √† traiter -->
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0 text-warning">Demandes de r√©servations √† traiter</h5>
            </div>
            <div class="card-body">
            <div id="pendingRequestsLoading" class="loading">Chargement...</div>
            <div id="pendingRequestsContainer" style="display: none;">
                <div class="table-responsive">
                <table class="table table-hover" id="pendingRequestsTable">
                    <thead class="table-light">
                        <tr>
                            <th>Date et heure d√©but</th>
                            <th>Date et heure fin</th>
                            <th>Utilisateur</th>
                            <th>Borne, Lieu</th>
                            <th>Montant r√©gl√©</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="pendingRequestsBody"></tbody>
                </table>
                </div>
                <div id="pendingRequestsEmpty" class="text-center py-5 text-muted" style="display: none;">
                    <p class="mb-0">Aucune demande en attente</p>
                </div>
            </div>
        </div>
        </div>
        
        <!-- Demandes de r√©servations trait√©es -->
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0 text-success">Demandes de r√©servations trait√©es</h5>
            </div>
            <div class="card-body">
            <div id="treatedRequestsLoading" class="loading">Chargement...</div>
            <div id="treatedRequestsContainer" style="display: none;">
                <div class="table-responsive">
                <table class="table table-hover" id="treatedRequestsTable">
                    <thead class="table-light">
                        <tr>
                            <th>Date et heure d√©but</th>
                            <th>Date et heure fin</th>
                            <th>Utilisateur</th>
                            <th>Borne, Lieu</th>
                            <th>Montant r√©gl√©</th>
                            <th>Statut</th>
                        </tr>
                    </thead>
                    <tbody id="treatedRequestsBody"></tbody>
                </table>
                </div>
                <div id="treatedRequestsEmpty" class="text-center py-5 text-muted" style="display: none;">
                    <p class="mb-0">Aucune demande trait√©e</p>
                </div>
                <div id="treatedPagination" class="d-flex justify-content-center mt-3"></div>
            </div>
        </div>
        </div>
    </div>

    <!-- IMPORTANT: Inclure backend-config AVANT tous les scripts -->
    <div th:replace="~{includes/backend-config :: backend-config}"></div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Scripts -->
    <script th:src="@{/js/config.js}"></script>
    <script th:src="@{/js/jwt-utils.js}"></script>
    <script>
        // Fonction utilitaire pour obtenir l'URL de base de l'API (toujours via proxy frontend)
        function getApiBaseUrl() {
            // V√©rifier dans l'ordre : API_BASE_URL global, window.API_BASE_URL, ou fallback vers origin
            if (typeof API_BASE_URL !== 'undefined' && API_BASE_URL && !API_BASE_URL.includes('localhost:8080')) {
                return API_BASE_URL;
            }
            if (typeof window.API_BASE_URL !== 'undefined' && window.API_BASE_URL && !window.API_BASE_URL.includes('localhost:8080')) {
                return window.API_BASE_URL;
            }
            // Fallback vers window.location.origin (frontend proxy)
            const origin = window.location.origin;
            console.warn('‚ö†Ô∏è API_BASE_URL non d√©fini, utilisation du fallback:', origin);
            // D√©finir pour les prochains appels
            if (typeof window !== 'undefined') {
                window.API_BASE_URL = origin;
            }
            if (typeof API_BASE_URL === 'undefined') {
                var API_BASE_URL = origin;
            }
            return origin;
        }
        
        let CURRENT_USER_ID = null;
        let allReservations = [];
        let allStations = [];
        let allLocations = [];
        let allUsers = [];
        
        // Pagination
        let currentPastPage = 1;
        let currentTreatedPage = 1;
        const itemsPerPage = 12;
        
        // V√©rifier l'authentification
        if (!requireAuth()) {
            // Redirection automatique
        } else {
            CURRENT_USER_ID = getCurrentUserId();
            const user = getAuthUser();
            if (user) {
                document.getElementById('welcomeMessage').textContent = 'Utilisateur : ' + user.firstName + ' ' + user.lastName;
            }
            
            // Charger toutes les donn√©es au d√©marrage
            loadAllData();
        }
        
        async function loadAllData() {
            try {
                const apiBase = getApiBaseUrl();
                console.log('üîß loadAllData - API_BASE_URL:', apiBase);
                
                const [reservations, stations, locations] = await Promise.all([
                    authenticatedFetch(apiBase + '/api/reservations').then(r => r.json()),
                    authenticatedFetch(apiBase + '/api/stations').then(r => r.json()),
                    authenticatedFetch(apiBase + '/api/locations').then(r => r.json())
                ]);
                
                allReservations = reservations.content || reservations;
                allStations = stations.content || stations;
                allLocations = locations.content || locations;
                
                loadCurrentReservations();
                loadPastReservations();
                loadLocations();
                loadPendingRequests();
                loadTreatedRequests();
                
            } catch (error) {
                                showError('Erreur lors du chargement des donn√©es');
            }
        }
        
        function loadCurrentReservations() {
            const container = document.getElementById('currentReservationsContainer');
            const loading = document.getElementById('currentReservationsLoading');
            const body = document.getElementById('currentReservationsBody');
            const empty = document.getElementById('currentReservationsEmpty');
            
            // R√©servations en cours = PENDING, CONFIRMED, ACTIVE ou CANCELLED dont la date n'est pas encore pass√©e
            const now = new Date();
            const current = allReservations.filter(r => {
                if (r.userId !== CURRENT_USER_ID) return false;
                
                // PENDING, CONFIRMED, ACTIVE sont toujours en cours
                if (['PENDING', 'CONFIRMED', 'ACTIVE'].includes(r.status)) return true;
                
                // CANCELLED seulement si la date de fin n'est pas encore pass√©e
                if (r.status === 'CANCELLED') {
                    const endTime = new Date(r.endTime);
                    return endTime >= now;
                }
                
                return false;
            });
            
            loading.style.display = 'none';
            container.style.display = 'block';
            
            if (current.length === 0) {
                empty.style.display = 'block';
                body.innerHTML = '';
                return;
            }
            
            empty.style.display = 'none';
            body.innerHTML = current.map(reservation => {
                const station = allStations.find(s => s.id === reservation.stationId);
                const location = allLocations.find(l => l.id === station?.locationId);
                const city = location?.city || 'N/A';
                
                let actions = '';
                if (reservation.status === 'PENDING') {
                    actions += '<button class="btn btn-danger btn-sm" onclick="cancelReservation(' + reservation.id + ')"><i class="bi bi-x-circle me-1"></i>Annuler</button>';
                }
                // Bouton PDF pour les r√©servations accept√©es (CONFIRMED) ou termin√©es (COMPLETED)
                if (reservation.status === 'CONFIRMED' || reservation.status === 'COMPLETED') {
                    if (actions) actions += ' ';
                    actions += '<button class="btn btn-info btn-sm" onclick="downloadReceipt(' + reservation.id + ')"><i class="bi bi-file-earmark-pdf me-1"></i>PDF</button>';
                }
                
                return '<tr>' +
                    '<td>' + formatDateTime(reservation.startTime) + '</td>' +
                    '<td>' + formatDateTime(reservation.endTime) + '</td>' +
                    '<td>' + (reservation.userFirstName + ' ' + reservation.userLastName) + '</td>' +
                    '<td>' + (reservation.stationName || 'N/A') + '<br>' + (reservation.locationLabel || 'N/A') + '<br>' + city + '</td>' +
                    '<td>' + (reservation.totalAmount ? reservation.totalAmount.toFixed(2) : '0.00') + ' ‚Ç¨</td>' +
                    '<td>' + getStatusBadge(reservation.status) + '</td>' +
                    '<td>' + actions + '</td>' +
                '</tr>';
            }).join('');
        }
        
        function loadPastReservations() {
            const container = document.getElementById('pastReservationsContainer');
            const loading = document.getElementById('pastReservationsLoading');
            const body = document.getElementById('pastReservationsBody');
            const empty = document.getElementById('pastReservationsEmpty');
            const pagination = document.getElementById('pastPagination');
            
            // R√©servations pass√©es = COMPLETED, REFUSED, CONFIRMED (date pass√©e), ou CANCELLED dont la date est pass√©e
            const now = new Date();
            const past = allReservations.filter(r => {
                if (r.userId !== CURRENT_USER_ID) return false;
                
                // COMPLETED et REFUSED sont toujours dans les r√©servations pass√©es
                if (r.status === 'COMPLETED' || r.status === 'REFUSED') return true;
                
                // CONFIRMED seulement si la date de fin est pass√©e (r√©servation accept√©e mais termin√©e)
                if (r.status === 'CONFIRMED') {
                    const endTime = new Date(r.endTime);
                    return endTime < now;
                }
                
                // CANCELLED seulement si la date de fin est pass√©e
                if (r.status === 'CANCELLED') {
                    const endTime = new Date(r.endTime);
                    return endTime < now;
                }
                
                return false;
            });
            
            loading.style.display = 'none';
            container.style.display = 'block';
            
            if (past.length === 0) {
                empty.style.display = 'block';
                body.innerHTML = '';
                pagination.innerHTML = ''; // Pas de pagination si aucune donn√©e
                return;
            }
            
            empty.style.display = 'none';
            
            // Calculer la pagination
            const totalPages = Math.ceil(past.length / itemsPerPage);
            const startIndex = (currentPastPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedPast = past.slice(startIndex, endIndex);
            
            body.innerHTML = paginatedPast.map(reservation => {
                const station = allStations.find(s => s.id === reservation.stationId);
                const location = allLocations.find(l => l.id === station?.locationId);
                const city = location?.city || 'N/A';
                
                // Bouton PDF uniquement pour les r√©servations accept√©es (CONFIRMED) ou termin√©es (COMPLETED)
                const pdfButton = (reservation.status === 'CONFIRMED' || reservation.status === 'COMPLETED')
                    ? '<button class="btn btn-info btn-sm" onclick="downloadReceipt(' + reservation.id + ')"><i class="bi bi-file-earmark-pdf me-1"></i>PDF</button>'
                    : '<span class="text-muted">-</span>';
                
                return '<tr>' +
                    '<td>' + formatDateTime(reservation.startTime) + '</td>' +
                    '<td>' + formatDateTime(reservation.endTime) + '</td>' +
                    '<td>' + (reservation.userFirstName + ' ' + reservation.userLastName) + '</td>' +
                    '<td>' + (reservation.stationName || 'N/A') + '<br>' + (reservation.locationLabel || 'N/A') + '<br>' + city + '</td>' +
                    '<td>' + (reservation.totalAmount ? reservation.totalAmount.toFixed(2) : '0.00') + ' ‚Ç¨</td>' +
                    '<td>' + getStatusBadge(reservation.status) + '</td>' +
                    '<td>' + pdfButton + '</td>' +
                '</tr>';
            }).join('');
            
            // G√©n√©rer les contr√¥les de pagination
            pagination.innerHTML = generatePaginationControls(currentPastPage, totalPages, 'changePastPage');
        }
        
        function loadLocations() {
            const container = document.getElementById('locationsContainer');
            const loading = document.getElementById('locationsLoading');
            const grid = document.getElementById('locationsGrid');
            const empty = document.getElementById('locationsEmpty');
            
            const myLocations = allLocations.filter(l => l.ownerId === CURRENT_USER_ID);
            
            loading.style.display = 'none';
            container.style.display = 'block';
            
            if (myLocations.length === 0) {
                empty.style.display = 'block';
                grid.innerHTML = '';
                return;
            }
            
            empty.style.display = 'none';
            grid.innerHTML = myLocations.map(location => {
                const locationStations = allStations.filter(s => s.locationId === location.id);
                
                return '<div class="location-card">' +
                    '<h4>' + (location.label || location.name || 'Lieu') + '</h4>' +
                    '<p class="text-muted small mb-2">' + (location.address || '') + (location.city ? ', ' + location.city : '') + '</p>' +
                    '<div>' +
                        locationStations.map(station => {
                            // V√©rifier si la station a des r√©servations (m√™me pass√©es)
                            const hasReservations = allReservations.some(r => r.stationId === station.id);
                            const isActive = station.status === 'ACTIVE';
                            
                            // Si la station a des r√©servations, on ne peut que d√©sactiver, pas supprimer
                            const deleteButton = hasReservations 
                                ? '<button class="btn btn-warning btn-sm" onclick="toggleStationStatus(' + station.id + ', ' + isActive + ')" title="Cette borne a des r√©servations, elle ne peut pas √™tre supprim√©e"><i class="bi bi-toggle-off me-1"></i>D√©sactiver</button>'
                                : '<button class="btn btn-danger btn-sm" onclick="deleteStation(' + station.id + ')"><i class="bi bi-trash me-1"></i>Supprimer</button>';
                            
                            return '<div class="station">' +
                                '<div class="station-name">' + station.name + '</div>' +
                                '<div class="station-rate">' + (station.hourlyRate ? station.hourlyRate.toFixed(2) : '0.00') + ' ‚Ç¨/h</div>' +
                                '<div class="mt-2 d-flex gap-1 flex-wrap">' +
                                    '<button class="btn btn-info btn-sm" onclick="window.location.href=\'/edit-station?id=' + station.id + '\'">Modifier</button>' +
                                    '<button class="btn btn-warning btn-sm" onclick="setStationRate(' + station.id + ')">Tarif</button>' +
                                    '<button class="btn btn-secondary btn-sm" onclick="uploadStationPhoto(' + station.id + ')"><i class="bi bi-image me-1"></i>Photo</button>' +
                                    '<button class="btn btn-secondary btn-sm" onclick="uploadStationVideo(' + station.id + ')"><i class="bi bi-camera-video me-1"></i>Vid√©o</button>' +
                                    deleteButton +
                                '</div>' +
                            '</div>';
                        }).join('') +
                    '</div>' +
                    '<div class="location-actions">' +
                        '<button class="btn btn-primary btn-sm" onclick="window.location.href=\'/edit-location?id=' + location.id + '\'">Modifier lieu</button>' +
                        '<button class="btn btn-success btn-sm" onclick="window.location.href=\'/add-station?locationId=' + location.id + '\'">Ajouter une borne</button>' +
                        '<button class="btn btn-danger btn-sm" onclick="deleteLocation(' + location.id + ')">Supprimer lieu</button>' +
                    '</div>' +
                '</div>';
            }).join('');
        }
        
        function loadPendingRequests() {
            const container = document.getElementById('pendingRequestsContainer');
            const loading = document.getElementById('pendingRequestsLoading');
            const body = document.getElementById('pendingRequestsBody');
            const empty = document.getElementById('pendingRequestsEmpty');
            
            // Demandes en attente = r√©servations PENDING sur MES bornes
            const myStationIds = allStations.filter(s => {
                const location = allLocations.find(l => l.id === s.locationId);
                return location && location.ownerId === CURRENT_USER_ID;
            }).map(s => s.id);
            
            const pending = allReservations.filter(r => 
                r.status === 'PENDING' && 
                myStationIds.includes(r.stationId) &&
                r.userId !== CURRENT_USER_ID
            );
            
            loading.style.display = 'none';
            container.style.display = 'block';
            
            if (pending.length === 0) {
                empty.style.display = 'block';
                body.innerHTML = '';
                return;
            }
            
            empty.style.display = 'none';
            body.innerHTML = pending.map(reservation => {
                return '<tr>' +
                    '<td>' + formatDateTime(reservation.startTime) + '</td>' +
                    '<td>' + formatDateTime(reservation.endTime) + '</td>' +
                    '<td>' + (reservation.userFirstName + ' ' + reservation.userLastName) + '</td>' +
                    '<td>' + (reservation.stationName || 'N/A') + '<br>' + (reservation.locationLabel || 'N/A') + '</td>' +
                    '<td>' + (reservation.totalAmount ? reservation.totalAmount.toFixed(2) : '0.00') + ' ‚Ç¨</td>' +
                    '<td>' +
                        '<button class="btn btn-success btn-sm me-2" onclick="acceptReservation(' + reservation.id + ')">Accepter</button>' +
                        '<button class="btn btn-danger btn-sm" onclick="refuseReservation(' + reservation.id + ')">Refuser</button>' +
                    '</td>' +
                '</tr>';
            }).join('');
        }
        
        function loadTreatedRequests() {
            const container = document.getElementById('treatedRequestsContainer');
            const loading = document.getElementById('treatedRequestsLoading');
            const body = document.getElementById('treatedRequestsBody');
            const empty = document.getElementById('treatedRequestsEmpty');
            const pagination = document.getElementById('treatedPagination');
            
            // Demandes trait√©es = r√©servations CONFIRMED, CANCELLED, COMPLETED sur MES bornes
            const myStationIds = allStations.filter(s => {
                const location = allLocations.find(l => l.id === s.locationId);
                return location && location.ownerId === CURRENT_USER_ID;
            }).map(s => s.id);
            
            const treated = allReservations.filter(r => 
                ['CONFIRMED', 'CANCELLED', 'COMPLETED'].includes(r.status) && 
                myStationIds.includes(r.stationId) &&
                r.userId !== CURRENT_USER_ID
            );
            
            loading.style.display = 'none';
            container.style.display = 'block';
            
            if (treated.length === 0) {
                empty.style.display = 'block';
                body.innerHTML = '';
                // Afficher la pagination m√™me si vide (Page 1 sur 1)
                pagination.innerHTML = generatePaginationControls(1, 1, 'changeTreatedPage');
                return;
            }
            
            empty.style.display = 'none';
            
            // Calculer la pagination
            const totalPages = Math.ceil(treated.length / itemsPerPage);
            const startIndex = (currentTreatedPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedTreated = treated.slice(startIndex, endIndex);
            
            body.innerHTML = paginatedTreated.map(reservation => {
                return '<tr>' +
                    '<td>' + formatDateTime(reservation.startTime) + '</td>' +
                    '<td>' + formatDateTime(reservation.endTime) + '</td>' +
                    '<td>' + (reservation.userFirstName + ' ' + reservation.userLastName) + '</td>' +
                    '<td>' + (reservation.stationName || 'N/A') + '<br>' + (reservation.locationLabel || 'N/A') + '</td>' +
                    '<td>' + (reservation.totalAmount ? reservation.totalAmount.toFixed(2) : '0.00') + ' ‚Ç¨</td>' +
                    '<td>' + getStatusBadge(reservation.status) + '</td>' +
                '</tr>';
            }).join('');
            
            // G√©n√©rer les contr√¥les de pagination
            pagination.innerHTML = generatePaginationControls(currentTreatedPage, totalPages, 'changeTreatedPage');
        }
        
        async function acceptReservation(id) {
            try {
                const response = await authenticatedFetch(getApiBaseUrl() + '/api/reservations/' + id + '/confirm', {
                    method: 'PUT'
                });
                if (!response.ok) throw new Error('Erreur');
                showSuccess('R√©servation accept√©e');
                loadAllData();
            } catch (error) {
                showError('Erreur lors de l\'acceptation');
            }
        }
        
        async function refuseReservation(id) {
            try {
                const response = await authenticatedFetch(getApiBaseUrl() + '/api/reservations/' + id + '/refuse', {
                    method: 'PUT'
                });
                if (!response.ok) throw new Error('Erreur');
                showSuccess('R√©servation refus√©e');
                loadAllData();
            } catch (error) {
                showError('Erreur lors du refus');
            }
        }
        
        async function cancelReservation(id) {
            try {
                const response = await authenticatedFetch(getApiBaseUrl() + '/api/reservations/' + id + '/cancel', {
                    method: 'PUT'
                });
                if (!response.ok) throw new Error('Erreur');
                showSuccess('R√©servation annul√©e');
                loadAllData();
            } catch (error) {
                showError('Erreur lors de l\'annulation');
            }
        }
        
        async function deleteLocation(id) {
            try {
                const response = await authenticatedFetch(getApiBaseUrl() + '/api/locations/' + id, {
                    method: 'DELETE'
                });
                if (!response.ok) throw new Error('Erreur');
                showSuccess('Lieu supprim√©');
                loadAllData();
            } catch (error) {
                showError('Erreur lors de la suppression');
            }
        }
        
        function filterPastReservations() {
            // R√©initialiser √† la premi√®re page lors du filtrage
            currentPastPage = 1;
            // TODO: Impl√©menter le filtre
            loadPastReservations();
            showSuccess('Filtre appliqu√©');
        }
        
        function resetPastFilter() {
            document.getElementById('filterDateStart').value = '';
            document.getElementById('filterDateEnd').value = '';
            currentPastPage = 1;
            loadPastReservations();
        }
        
        function changePastPage(page) {
            if (page < 1) return;
            currentPastPage = page;
            loadPastReservations();
            // Scroller vers le haut du tableau apr√®s changement de page
            document.getElementById('pastReservationsTable').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        function changeTreatedPage(page) {
            if (page < 1) return;
            currentTreatedPage = page;
            loadTreatedRequests();
            // Scroller vers le haut du tableau apr√®s changement de page
            document.getElementById('treatedRequestsTable').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        function generatePaginationControls(currentPage, totalPages, changeFunction) {
            // La pagination est toujours affich√©e, m√™me avec une seule page
            if (totalPages <= 0) totalPages = 1;
            
            let html = '<nav><ul class="pagination mb-0">';
            
            // Bouton premi√®re page
            html += '<li class="page-item' + (currentPage === 1 ? ' disabled' : '') + '">';
            html += '<a class="page-link" href="#" onclick="' + changeFunction + '(1); return false;" aria-label="Premi√®re page">';
            html += '<span aria-hidden="true">&laquo;</span>';
            html += '</a></li>';
            
            // Bouton pr√©c√©dent
            html += '<li class="page-item' + (currentPage === 1 ? ' disabled' : '') + '">';
            html += '<a class="page-link" href="#" onclick="' + changeFunction + '(' + (currentPage - 1) + '); return false;" aria-label="Pr√©c√©dent">';
            html += '<span aria-hidden="true">&lsaquo;</span>';
            html += '</a></li>';
            
            // Affichage des num√©ros de pages (max 5 pages visibles)
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage < maxVisiblePages - 1) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            if (startPage > 1) {
                html += '<li class="page-item"><a class="page-link" href="#" onclick="' + changeFunction + '(1); return false;">1</a></li>';
                if (startPage > 2) {
                    html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                html += '<li class="page-item' + (i === currentPage ? ' active' : '') + '">';
                html += '<a class="page-link" href="#" onclick="' + changeFunction + '(' + i + '); return false;">' + i + '</a>';
                html += '</li>';
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
                }
                html += '<li class="page-item"><a class="page-link" href="#" onclick="' + changeFunction + '(' + totalPages + '); return false;">' + totalPages + '</a></li>';
            }
            
            // Bouton suivant
            html += '<li class="page-item' + (currentPage === totalPages ? ' disabled' : '') + '">';
            html += '<a class="page-link" href="#" onclick="' + changeFunction + '(' + (currentPage + 1) + '); return false;" aria-label="Suivant">';
            html += '<span aria-hidden="true">&rsaquo;</span>';
            html += '</a></li>';
            
            // Bouton derni√®re page
            html += '<li class="page-item' + (currentPage === totalPages ? ' disabled' : '') + '">';
            html += '<a class="page-link" href="#" onclick="' + changeFunction + '(' + totalPages + '); return false;" aria-label="Derni√®re page">';
            html += '<span aria-hidden="true">&raquo;</span>';
            html += '</a></li>';
            
            html += '</ul></nav>';
            
            return html;
        }
        
        async function downloadReceipt(reservationId) {
            try {
                console.log('üìÑ T√©l√©chargement du re√ßu PDF pour la r√©servation #' + reservationId);
                const response = await authenticatedFetch(getApiBaseUrl() + '/api/reservations/' + reservationId + '/receipt.pdf');
                
                if (!response.ok) {
                    if (response.status === 404) {
                        showError('R√©servation non trouv√©e');
                    } else {
                        showError('Erreur lors du t√©l√©chargement du PDF');
                    }
                    return;
                }
                
                // Cr√©er un blob √† partir de la r√©ponse
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                
                // Cr√©er un lien de t√©l√©chargement
                const link = document.createElement('a');
                link.href = url;
                link.download = 'receipt-' + reservationId + '.pdf';
                document.body.appendChild(link);
                link.click();
                
                // Nettoyer
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
                
                showSuccess('Re√ßu PDF t√©l√©charg√© avec succ√®s');
            } catch (error) {
                console.error('Erreur lors du t√©l√©chargement du PDF:', error);
                showError('Erreur lors du t√©l√©chargement du PDF');
            }
        }
        
        async function setStationRate(stationId) {
            const station = allStations.find(s => s.id === stationId);
            const currentRate = station ? (station.hourlyRate || 0) : 0;
            const newRate = prompt('Entrez le nouveau tarif horaire (‚Ç¨/h) :', currentRate.toFixed(2));
            
            if (newRate && !isNaN(newRate) && parseFloat(newRate) >= 0) {
                try {
                    const response = await authenticatedFetch(getApiBaseUrl() + '/api/stations/' + stationId, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            hourlyRate: parseFloat(newRate)
                        })
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(errorText || 'Erreur lors de la modification du tarif');
                    }
                    
                    showSuccess('Tarif mis √† jour avec succ√®s');
                    loadAllData();
                } catch (error) {
                    console.error('Erreur lors de la modification du tarif:', error);
                    showError('Erreur lors de la modification du tarif: ' + error.message);
                }
            } else if (newRate !== null) {
                showError('Veuillez entrer un tarif valide (nombre positif)');
            }
        }
        
        async function toggleStationStatus(stationId, currentStatus) {
            try {
                const response = await authenticatedFetch(getApiBaseUrl() + '/api/stations/' + stationId, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        isActive: !currentStatus
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Erreur lors de la modification');
                }
                
                const newStatus = !currentStatus ? 'activ√©e' : 'd√©sactiv√©e';
                showSuccess('Borne ' + newStatus + ' avec succ√®s');
                loadAllData();
            } catch (error) {
                console.error('Erreur lors de la modification du statut:', error);
                showError('Erreur lors de la modification: ' + error.message);
            }
        }
        
        async function deleteStation(stationId) {
            try {
                const response = await authenticatedFetch(getApiBaseUrl() + '/api/stations/' + stationId, {
                    method: 'DELETE'
                });
                if (!response.ok) throw new Error('Erreur');
                showSuccess('Borne supprim√©e');
                loadAllData();
            } catch (error) {
                showError('Erreur lors de la suppression');
            }
        }
        
        function uploadStationPhoto(stationId) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const formData = new FormData();
                formData.append('file', file);
                formData.append('stationId', stationId);
                formData.append('type', 'IMAGE');
                
                try {
                    // Le token est dans un cookie HttpOnly, pas besoin de header Authorization
                    const response = await fetch(getApiBaseUrl() + '/api/medias/upload', {
                        method: 'POST',
                        credentials: 'include', // IMPORTANT: pour envoyer le cookie HttpOnly
                        body: formData
                    });
                    
                    if (response.ok) {
                        showSuccess('Photo t√©l√©vers√©e avec succ√®s');
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        const error = await response.text();
                        showError('Erreur : ' + error);
                    }
                } catch (error) {
                    console.error('Erreur upload :', error);
                    showError('Erreur lors du t√©l√©versement');
                }
            };
            input.click();
        }
        
        function uploadStationVideo(stationId) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'video/*';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const formData = new FormData();
                formData.append('file', file);
                formData.append('stationId', stationId);
                formData.append('type', 'VIDEO');
                
                try {
                    // Le token est dans un cookie HttpOnly, pas besoin de header Authorization
                    const response = await fetch(getApiBaseUrl() + '/api/medias/upload', {
                        method: 'POST',
                        credentials: 'include', // IMPORTANT: pour envoyer le cookie HttpOnly
                        body: formData
                    });
                    
                    if (response.ok) {
                        showSuccess('Vid√©o t√©l√©vers√©e avec succ√®s');
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        const error = await response.text();
                        showError('Erreur : ' + error);
                    }
                } catch (error) {
                    console.error('Erreur upload :', error);
                    showError('Erreur lors du t√©l√©versement');
                }
            };
            input.click();
        }
        
        function exportToExcel() {
            // R√©cup√©rer toutes les r√©servations pass√©es de l'utilisateur
            const now = new Date();
            const pastReservations = allReservations.filter(r => {
                if (r.userId !== CURRENT_USER_ID) return false;
                if (r.status === 'COMPLETED' || r.status === 'REFUSED') return true;
                if (r.status === 'CANCELLED') {
                    const endTime = new Date(r.endTime);
                    return endTime < now;
                }
                return false;
            });
            
            if (pastReservations.length === 0) {
                showError('Aucune r√©servation pass√©e √† exporter');
                return;
            }
            
            // Cr√©er le contenu CSV
            let csv = 'Date et heure debut,Date et heure fin,Utilisateur,Borne,Lieu,Ville,Montant regle,Statut\n';
            
            pastReservations.forEach(reservation => {
                const station = allStations.find(s => s.id === reservation.stationId);
                const location = allLocations.find(l => l.id === station?.locationId);
                const city = location?.city || 'N/A';
                
                csv += formatDateTime(reservation.startTime) + ',' +
                       formatDateTime(reservation.endTime) + ',' +
                       (reservation.userFirstName + ' ' + reservation.userLastName) + ',' +
                       (reservation.stationName || 'N/A') + ',' +
                       (reservation.locationLabel || 'N/A') + ',' +
                       city + ',' +
                       (reservation.totalAmount ? reservation.totalAmount.toFixed(2) : '0.00') + ' EUR,' +
                       getStatusText(reservation.status) + '\n';
            });
            
            // Cr√©er un blob et t√©l√©charger
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', 'reservations_passees_' + new Date().getTime() + '.csv');
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showSuccess('Export r√©ussi !');
        }
        
        function formatDateTime(dateTimeStr) {
            if (!dateTimeStr) return 'N/A';
            
            const date = new Date(dateTimeStr);
            
            // V√©rifier si la date est valide
            if (isNaN(date.getTime())) return 'Date invalide';
            
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return day + '/' + month + '/' + year + ' ' + hours + ':' + minutes;
        }
        
        function getStatusText(status) {
            const statusMap = {
                'PENDING': 'En attente',
                'CONFIRMED': 'Accept√©',
                'ACTIVE': 'En cours',
                'COMPLETED': 'Termin√©',
                'CANCELLED': 'Annul√©',
                'REFUSED': 'Refus√©'
            };
            return statusMap[status] || status;
        }
        
        function getStatusBadge(status) {
            let badgeClass = '';
            let text = '';
            
            switch(status) {
                case 'CONFIRMED':
                case 'COMPLETED':
                    badgeClass = 'badge bg-success rounded-pill';
                    text = status === 'CONFIRMED' ? 'Accept√©' : 'Termin√©';
                    break;
                case 'REFUSED':
                case 'CANCELLED':
                    badgeClass = 'badge bg-danger rounded-pill';
                    text = status === 'REFUSED' ? 'Refus√©' : 'Annul√©';
                    break;
                case 'PENDING':
                    badgeClass = 'badge bg-warning text-dark rounded-pill';
                    text = 'En attente';
                    break;
                case 'ACTIVE':
                    badgeClass = 'badge bg-info text-dark rounded-pill';
                    text = 'En cours';
                    break;
                default:
                    badgeClass = 'badge bg-secondary rounded-pill';
                    text = status;
            }
            
            return '<span class="' + badgeClass + '">' + text + '</span>';
        }
        
        function showError(message) {
            const container = document.getElementById('messageContainer');
            container.innerHTML = '<div class="message error">' + message + '</div>';
            setTimeout(() => container.innerHTML = '', 5000);
        }
        
        function showSuccess(message) {
            const container = document.getElementById('messageContainer');
            container.innerHTML = '<div class="message success">' + message + '</div>';
            setTimeout(() => container.innerHTML = '', 3000);
        }
        
        async function logout() {
            // Appeler l'API de logout pour supprimer le cookie HttpOnly c√¥t√© serveur
            try {
                await fetch(getApiBaseUrl() + '/api/auth/logout', {
                    method: 'POST',
                    credentials: 'include' // IMPORTANT: pour envoyer le cookie √† supprimer
                });
            } catch (e) {
                console.warn('Erreur lors de l\'appel API logout:', e);
            }
            
            // Nettoyer le localStorage
            if (typeof clearAuthData === 'function') {
                clearAuthData();
            } else {
            localStorage.clear();
            }
            sessionStorage.clear();
            
            // Rediriger vers /login
            window.location.replace('/login');
        }
    </script>
    <th:block th:replace="~{includes/navbar :: scripts-bootstrap}"></th:block>
    <div th:replace="~{includes/navbar :: navbar-script}"></div>
</body>
</html>
