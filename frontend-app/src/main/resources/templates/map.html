<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:replace="~{includes/navbar :: head-bootstrap}"></th:block>
    <title>Carte des Stations - Electricity Business</title>
    <!-- Configuration backend (inclus une seule fois) -->
    <div th:replace="~{includes/backend-config :: backend-config}"></div>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <style>
        html, body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 0;
            background-color: white; 
            height: 100vh;
            width: 100vw;
            overflow: hidden;
        }
        
        @media (max-width: 768px) {
            html, body {
                overflow: hidden;
            }
        }
        
        .header { 
            background-color: white; 
            color: #333; 
            padding: 15px 20px; 
            border-bottom: 1px solid #ddd;
            position: relative;
            z-index: 1000;
        }
        
        .header h1 { 
            margin: 0; 
            display: inline-block; 
            font-size: 20px;
        }
        
        .header .user-info { 
            float: right; 
            margin-top: 2px; 
        }
        
        .header .user-info a { 
            color: #1E40AF; 
            text-decoration: none; 
            margin-left: 15px; 
            font-size: 14px;
        }
        
        .header .user-info a:hover { 
            text-decoration: underline; 
        }
        
        .search-section {
            background: white;
            padding: 20px;
            border-bottom: 1px solid #ddd;
            flex-shrink: 0;
        }
        
        .search-title {
            text-align: center;
            font-size: 1.5em;
            margin-bottom: 20px;
            color: #333;
        }
        
        .search-form {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 1fr auto;
            gap: 15px;
            align-items: end;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .search-form .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .search-form label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }
        
        .search-form input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .search-form .search-btn {
            background: #1E40AF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            height: fit-content;
            align-self: end;
            white-space: nowrap;
        }
        
        .search-form .search-btn:hover {
            background: #1e293b;
        }
        
        /* Conteneur principal sans scroll */
        body {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-height: 100vh;
            overflow: hidden !important;
            width: 100vw;
            margin: 0;
            padding: 0;
        }
        
        /* Navbar fixe en haut */
        .navbar {
            flex-shrink: 0;
            position: relative;
            z-index: 1030;
        }
        
        .container-fluid.p-0 {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden !important;
            min-height: 0;
            max-height: 100%;
        }
        
        .search-section {
            flex-shrink: 0;
        }
        
        .map-container {
            flex: 1;
            position: relative;
            width: 100%;
            overflow: hidden;
            min-height: 0;
        }
        
        @media (max-width: 768px) {
            .map-container {
                flex: 1;
            }
            
            .search-form {
                grid-template-columns: 1fr 1fr !important;
            }
            
            .search-form .form-group:last-child {
                grid-column: 1 / -1;
            }
        }
        
        #map {
            height: 100%;
            width: 100%;
        }
        
        /* Bulles de prix personnalisées - forme ronde parfaite */
        .price-marker {
            background-color: #1E40AF;
            color: white;
            border-radius: 50%;
            font-weight: bold;
            font-size: 10px;
            border: 3px solid white;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
            white-space: nowrap;
            text-align: center;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            line-height: 1;
        }
        
        .price-marker:hover {
            background-color: #1E3A8A;
            cursor: pointer;
            transform: scale(1.2);
            transition: all 0.2s ease;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.5);
        }
        
        /* Assurer que le conteneur du marqueur est rond */
        .custom-div-icon {
            background: transparent !important;
            border: none !important;
        }
        
        .controls {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        
        .controls button {
            display: block;
            width: 100%;
            margin-bottom: 5px;
            padding: 8px 12px;
            background-color: #1E40AF;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .controls button:hover {
            background-color: #1e293b;
        }
        
        .station-popup {
            font-family: Arial, sans-serif;
        }
        
        .station-popup h3 {
            margin: 0 0 10px 0;
            color: #1E40AF;
            font-size: 16px;
        }
        
        .station-popup p {
            margin: 5px 0;
            font-size: 14px;
            color: #333;
        }
        
        .station-popup .price {
            font-weight: bold;
            color: #28a745;
            font-size: 16px;
        }
        
        .station-popup .btn {
            display: inline-block;
            padding: 8px 16px;
            background-color: #1E40AF;
            color: white;
            text-decoration: none;
            border-radius: 3px;
            margin-top: 10px;
            font-size: 12px;
        }
        
        .station-popup .btn:hover {
            background-color: #1e293b;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div th:replace="~{includes/navbar :: navbar}"></div>
    
    <div class="container-fluid p-0">
        <div class="search-section">
            <h2 class="search-title">Trouver une borne disponible autour de soi</h2>
            <form class="search-form" id="searchForm">
                <div class="form-group">
                    <label for="location">Lieu</label>
                    <input type="text" id="location" name="location" value="Paris" placeholder="Paris">
                </div>
                
                <div class="form-group">
                    <label for="startDate">Date de début</label>
                    <input type="date" id="startDate" name="startDate" value="2023-10-06">
                </div>
                
                <div class="form-group">
                    <label for="startTime">Heure de début</label>
                    <input type="time" id="startTime" name="startTime" value="10:00">
                </div>
                
                <div class="form-group">
                    <label for="endDate">Date de fin</label>
                    <input type="date" id="endDate" name="endDate" value="2023-10-06">
                </div>
                
                <div class="form-group">
                    <label for="endTime">Heure de fin</label>
                    <input type="time" id="endTime" name="endTime" value="18:00">
                </div>
                
                <div class="form-group">
                    <button type="submit" class="search-btn">Rechercher</button>
                </div>
            </form>
        </div>
        
        <div class="map-container">
        <div id="map"></div>
        
        <div class="controls">
            <button onclick="getUserLocation()">Ma Position</button>
            <button onclick="toggleNearbySearch()">Recherche Proximité</button>
            <button id="togglePublicBtn" onclick="togglePublicStations()" style="background: #6c757d;">Afficher bornes publiques</button>
        </div>
        
        <div id="loading" class="loading" style="display: none;">
            <p>Chargement des stations...</p>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script th:src="@{/js/config.js}"></script>
    <!-- jwt-utils.js est déjà chargé dans navbar.html, pas besoin de le recharger -->
    <script th:src="@{/js/auth.js}"></script>
    <script>
        let map;
        let stationsLayer;
        let ocmClusterLayer;
        let userLocation = null;
        let nearbyMode = false;
        
        function createPriceIcon(price) {
            let priceText = 'N/A';
            if (price) {
                const formattedPrice = parseFloat(price).toFixed(1);
                priceText = formattedPrice.endsWith('.0') 
                    ? Math.round(price).toString() + '€' 
                    : formattedPrice + '€';
            }
            return L.divIcon({
                className: 'custom-div-icon',
                html: `<div class="price-marker">${priceText}</div>`,
                iconSize: [32, 32],
                iconAnchor: [16, 16],
                popupAnchor: [0, -16]
            });
        }
        
        const ocmStationIcon = L.divIcon({
            className: 'ocm-station-marker',
            html: '<div style="background-color: #28a745; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>',
            iconSize: [20, 20],
            iconAnchor: [10, 10]
        });
        
        async function loadAllStations(keepMapPosition = false) {
            showLoading(true);
            stationsLayer.clearLayers();
            
            const currentCenter = keepMapPosition ? map.getCenter() : null;
            const currentZoom = keepMapPosition ? map.getZoom() : null;
            
            try {
                const response = await fetch((window.API_BASE_URL || window.location.origin) + '/api/stations/map', { credentials: 'include' });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                const stations = Array.isArray(data) ? data : (data.content || []);
                
                if (stations.length === 0) {
                    showLoading(false);
                    return;
                }
                
                stations.forEach(station => {
                    if (station.latitude && station.longitude) {
                        const priceIcon = createPriceIcon(station.hourlyRate);
                        const marker = L.marker([station.latitude, station.longitude], { icon: priceIcon })
                            .bindPopup(createStationPopup(station));
                        
                        stationsLayer.addLayer(marker);
                    }
                });
                
                if (stationsLayer.getLayers().length > 0) {
                    const group = new L.featureGroup(stationsLayer.getLayers());
                    if (!keepMapPosition) {
                        map.fitBounds(group.getBounds().pad(0.1));
                    } else if (currentCenter && currentZoom) {
                        map.setView(currentCenter, currentZoom);
                    }
                }
                
                showLoading(false);
            } catch (error) {
                showLoading(false);
                console.error('Erreur lors du chargement des stations:', error.message);
            }
        }
        
        function getUserLocation() {
            if (navigator.geolocation) {
                showLoading(true);
                
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        userLocation = [position.coords.latitude, position.coords.longitude];
                        
                        const userMarker = L.marker(userLocation, {
                            icon: L.divIcon({
                                className: 'user-marker',
                                html: '<div style="background-color: #28a745; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center;"></div>',
                                iconSize: [24, 24],
                                iconAnchor: [12, 12],
                                popupAnchor: [0, -12]
                            })
                        }).bindPopup('Votre position').addTo(map);
                        
                        // Centrer la carte sur la position de l'utilisateur avec animation
                        map.flyTo(userLocation, 14, {
                            duration: 1.5
                        });
                        
                        // Charger les stations à proximité (en gardant la position de la carte)
                        setTimeout(() => {
                            loadNearbyStations(userLocation[0], userLocation[1], 10, true);
                        }, 500);
                        
                        showLoading(false);
                    },
                    function(error) {
                        showLoading(false);
                        let errorMessage = 'Erreur de géolocalisation: ';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage += 'Permission refusée. Autorisez la géolocalisation dans votre navigateur.';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage += 'Position indisponible.';
                                break;
                            case error.TIMEOUT:
                                errorMessage += 'Délai d\'attente dépassé.';
                                break;
                            default:
                                errorMessage += 'Erreur inconnue.';
                        }
                        console.error('Erreur géolocalisation:', errorMessage);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } else {
            }
        }
        
        async function loadNearbyStations(lat, lng, radius = 10, keepMapPosition = false) {
            if (!lat || !lng || isNaN(lat) || isNaN(lng)) {
                loadAllStations(keepMapPosition);
                return;
            }
            
            showLoading(true);
            stationsLayer.clearLayers();
            
            try {
                const response = await fetch(`${window.API_BASE_URL || window.location.origin}/api/stations/nearby?latitude=${lat}&longitude=${lng}&radiusKm=${radius}`, { credentials: 'include' });
                
                if (!response.ok) {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                const stations = Array.isArray(data) ? data : (data.content || []);
                
                if (!Array.isArray(stations)) {
                    showLoading(false);
                    return;
                }
                
                stations.forEach(station => {
                    if (station.latitude && station.longitude) {
                        const priceIcon = createPriceIcon(station.hourlyRate);
                        const marker = L.marker([station.latitude, station.longitude], { icon: priceIcon })
                            .bindPopup(createStationPopup(station));
                        
                        stationsLayer.addLayer(marker);
                    }
                });
                
                showLoading(false);
            } catch (error) {
                showLoading(false);
                loadAllStations(true);
            }
        }
        
        function createStationPopup(station) {
            const address = station.address || 'Adresse non disponible';
            const rate = station.hourlyRate ? station.hourlyRate + '€/h' : 'N/A';
            const label = station.locationLabel || 'Lieu non spécifié';
            const plugType = station.plugType || 'TYPE2S';
            
            return '<div class="station-popup">' +
                '<h3>' + (station.name || 'Sans nom') + '</h3>' +
                '<p><strong>Lieu:</strong> ' + label + '</p>' +
                '<p><strong>Adresse:</strong> ' + address + '</p>' +
                '<p><strong>Tarif:</strong> <span class="price">' + rate + '</span></p>' +
                '<p><strong>Type de prise:</strong> ' + plugType + '</p>' +
                '<a href="#" onclick="reserveStation(' + station.id + '); return false;" class="btn">Réserver</a>' +
                '</div>';
        }
        
        // Créer un popup pour les stations OpenChargeMap
        function createOCMStationPopup(station) {
            const addr = station.AddressInfo || {};
            const address = addr.AddressLine1 || 'Adresse non disponible';
            const town = addr.Town || '';
            const country = addr.Country ? addr.Country.Title : 'France';
            const connections = station.Connections || [];
            const connectionTypes = connections.length > 0 
                ? connections.map(c => c.ConnectionType ? c.ConnectionType.Title : 'N/A').join(', ')
                : 'Type non spécifié';
            
            return '<div class="station-popup">' +
                '<h3 style="color: #28a745;">' + (addr.Title || 'Station de recharge') + '</h3>' +
                '<p><strong>Adresse:</strong> ' + address + (town ? ', ' + town : '') + '</p>' +
                '<p><strong>Pays:</strong> ' + country + '</p>' +
                '<p><strong>Type de prise:</strong> ' + connectionTypes + '</p>' +
                '<p><em style="color: #666; font-size: 12px;">Station externe (OpenChargeMap) - Informations uniquement</em></p>' +
                '</div>';
        }
        
        // Basculer le mode recherche à proximité
        function toggleNearbySearch() {
            nearbyMode = !nearbyMode;
            
            if (nearbyMode && userLocation) {
                loadNearbyStations(userLocation[0], userLocation[1]);
            } else if (!nearbyMode) {
                loadAllStations();
            } else {
                getUserLocation();
            }
        }
        
        function reserveStation(stationId) {
            if (!isAuthenticated || !isAuthenticated()) {
                const returnUrl = encodeURIComponent('/add-reservation?stationId=' + stationId);
                window.location.href = '/login?returnUrl=' + returnUrl;
                return;
            }
            
            window.location.href = '/add-reservation?stationId=' + stationId;
        }
        
        // Afficher/masquer le loading
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
        
        let showPublicStations = false;
        
        async function loadOCMBoundingBox() {
            if (!showPublicStations) {
                ocmClusterLayer.clearLayers();
                return;
            }
            
            let lat = 48.8566;
            let lng = 2.3522;
            
            try {
                const bounds = map.getBounds();
                if (bounds && bounds.isValid()) {
                    const center = bounds.getCenter();
                    if (center && typeof center.lat === 'number' && typeof center.lng === 'number') {
                        lat = center.lat;
                        lng = center.lng;
                    }
                }
            } catch (e) {
                // Ignorer les erreurs de bounds
            }
            
            // Appel direct à l'API OpenChargeMap (bornes publiques françaises)
            // Clé API de développement publique - à remplacer en production
            const OCM_API_KEY = '93b912b5-9d70-4b1f-960b-fb80a4c9c017';
            const url = `https://api.openchargemap.io/v3/poi/?output=json&countrycode=FR&latitude=${lat}&longitude=${lng}&distance=50&maxresults=100&compact=true&verbose=false&key=${OCM_API_KEY}`;
            
            showLoading(true);
            
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }
                const stations = await response.json();
                
                // Purger la couche OCM avant d'ajouter
                ocmClusterLayer.clearLayers();
                
                // Ajouter les stations OCM à la carte (cluster)
                if (Array.isArray(stations)) {
                    stations.forEach(station => {
                        const addr = station.AddressInfo;
                        if (addr && addr.Latitude && addr.Longitude) {
                            const marker = L.marker([addr.Latitude, addr.Longitude], { icon: ocmStationIcon })
                                .bindPopup(createOCMStationPopup(station));
                            
                            ocmClusterLayer.addLayer(marker);
                        }
                    });
                }
                
                showLoading(false);
            } catch (error) {
                console.error('Erreur chargement OpenChargeMap:', error);
                showLoading(false);
            }
        }
        
        function togglePublicStations() {
            showPublicStations = !showPublicStations;
            const btn = document.getElementById('togglePublicBtn');
            if (btn) {
                btn.textContent = showPublicStations ? 'Cacher bornes publiques' : 'Afficher bornes publiques';
                btn.style.background = showPublicStations ? '#28a745' : '#6c757d';
            }
            loadOCMBoundingBox();
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof getAuthUser === 'function') {
                const user = getAuthUser();
                if (user && user.firstName && user.lastName) {
                    const welcomeEl = document.getElementById('welcomeMessage');
                    if (welcomeEl) {
                        welcomeEl.textContent = 'Utilisateur : ' + user.firstName + ' ' + user.lastName;
                    }
                }
            }
            
            map = L.map('map').setView([48.8566, 2.3522], 10);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
            
            stationsLayer = L.layerGroup().addTo(map);
            ocmClusterLayer = L.markerClusterGroup({
                maxClusterRadius: 60,
                disableClusteringAtZoom: 16,
                spiderfyOnMaxZoom: true,
                showCoverageOnHover: false
            }).addTo(map); // bornes OpenChargeMap
            
            loadAllStations();
            setupSearchForm();
            
            let loadTimeout = null;
            let loading = false;
            let abortController = null;
            
            function loadStations() {
                if (abortController) abortController.abort();
                if (loadTimeout) clearTimeout(loadTimeout);
                
                loadTimeout = setTimeout(() => {
                    if (loading || !map) return;
                    
                    loading = true;
                    abortController = new AbortController();
                    
                    const center = map.getCenter();
                    const zoom = map.getZoom();
                    
                    const lat = center ? center.lat : 48.8566;
                    const lng = center ? center.lng : 2.3522;
                    
                    const distance = zoom < 8 ? 20 : zoom < 10 ? 15 : zoom < 12 ? 10 : 5;
                    const maxResults = zoom < 8 ? 50 : zoom < 10 ? 30 : zoom < 12 ? 20 : 10;
                    
                    const apiBase = window.API_BASE_URL || window.location.origin;
                    const url = `${apiBase}/api/stations/external?latitude=${lat}&longitude=${lng}&distance=${distance}&maxResults=${maxResults}`;
                    
                    fetch(url, { signal: abortController.signal, credentials: 'include' })
                        .then(res => res.json())
                        .then(data => {
                            const stations = Array.isArray(data) ? data : [];
                            ocmClusterLayer.clearLayers();
                            
                            stations.forEach(station => {
                                const location = locations.find(l => l.id === station.locationId);
                                const lat = location ? location.latitude : (station.AddressInfo && station.AddressInfo.Latitude);
                                const lng = location ? location.longitude : (station.AddressInfo && station.AddressInfo.Longitude);
                                
                                if (lat && lng) {
                                    const marker = L.marker([lat, lng], { icon: ocmStationIcon })
                                        .bindPopup(createOCMStationPopup(station));
                                    ocmClusterLayer.addLayer(marker);
                                }
                            });
                            
                            loading = false;
                            abortController = null;
                        })
                        .catch(err => {
                            if (err.name !== 'AbortError') {
                                loading = false;
                                abortController = null;
                            }
                        });
                }, 1000);
            }
            
            setTimeout(loadStations, 3000);
            
            map.on('moveend', loadStations);
            map.on('resize', loadStations);
            
            let lastZoom = map.getZoom() || 10;
            map.on('zoomend', function() {
                const currentZoom = map.getZoom() || 10;
                if (Math.abs(currentZoom - lastZoom) >= 2) {
                    lastZoom = currentZoom;
                    loadStations();
                }
            });
        });
        
        function setupSearchForm() {
            const searchForm = document.getElementById('searchForm');
            searchForm.addEventListener('submit', function(e) {
                e.preventDefault();
                performSearch();
            });
        }
        
        function performSearch() {
            const formData = new FormData(document.getElementById('searchForm'));
            const location = formData.get('location');
            const startDate = formData.get('startDate');
            const startTime = formData.get('startTime');
            const endDate = formData.get('endDate');
            const endTime = formData.get('endTime');

            // Pour l'instant, on recharge toutes les stations
            // Dans une vraie implémentation, on filtrerait par date/heure
            loadAllStations();
            
            // Optionnel : centrer la carte sur le lieu recherché
            if (location && location.toLowerCase() === 'paris') {
                map.setView([48.8566, 2.3522], 13); // Centre de Paris
            }
        }
    </script>
    
    <!-- Scripts Bootstrap communs -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Charger les scripts d'authentification (inclus dans scripts-bootstrap) -->
    <th:block th:replace="~{includes/navbar :: scripts-bootstrap}"></th:block>
    
    <!-- Script pour mettre à jour le nom d'utilisateur dans la navbar -->
    <div th:replace="~{includes/navbar :: navbar-script}"></div>
    
    <script>
        (function() {
            function updateNavbar() {
                if (typeof updateNavbarAuth === 'function') {
                    updateNavbarAuth();
                    return;
                }
                
                if (typeof isAuthenticated !== 'function' || typeof getAuthUser !== 'function') {
                    return;
                }
                
                const user = getAuthUser();
                const loginItem = document.getElementById('loginItem');
                const logoutItem = document.getElementById('logoutItem');
                const welcomeEl = document.getElementById('welcomeMessage');
                const welcomeItem = document.getElementById('welcomeItem');
                
                if (user) {
                    if (loginItem) loginItem.style.display = 'none';
                    if (logoutItem) logoutItem.style.display = 'flex';
                    if (welcomeItem) welcomeItem.style.display = 'flex';
                    if (welcomeEl) {
                        welcomeEl.textContent = user.firstName && user.lastName
                            ? `Utilisateur : ${user.firstName} ${user.lastName}`
                            : `Utilisateur : ${user.email}`;
                    }
                } else {
                    if (loginItem) loginItem.style.display = 'flex';
                    if (logoutItem) logoutItem.style.display = 'none';
                    if (welcomeItem) welcomeItem.style.display = 'none';
                    if (welcomeEl) welcomeEl.textContent = '';
                }
            }
            
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', updateNavbar);
            } else {
                updateNavbar();
            }
            
            window.addEventListener('storage', function(e) {
                if (e.key === 'authUser' || e.key === 'authToken') {
                    updateNavbar();
                }
            });
        })();
    </script>
</body>
</html>
