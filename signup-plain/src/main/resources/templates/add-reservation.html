
<div th:replace="~{includes/backend-config :: backend-config}"></div>

<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:replace="~{includes/navbar :: head-bootstrap}"></th:block>
    <title>Nouvelle R√©servation - Electricity Business</title>
    <link rel="stylesheet" th:href="@{/css/common-styles.css?v=20251022v5}">
    <style>
        .form-container {
            max-width: 800px;
            margin: 0 auto;
        }
        .station-input-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .station-input-container select {
            flex: 1;
        }
    </style>
</head>
<body>
    <div th:replace="~{includes/navbar :: navbar}"></div>
    
    <div class="container-main">

    <div class="container">
        <div class="content">
            <div id="messageContainer"></div>
            
            <div id="loadingIndicator" class="loading">
                <p>Chargement des bornes disponibles...</p>
            </div>
            
            <div id="formContainer" class="form-container" style="display: none;">
                <form id="reservationForm">
                    <div class="form-group">
                        <label for="stationId">Borne </label>
                        <div class="station-input-container" style="max-width: 600px;">
                            <input type="text" id="stationSearch" placeholder="Rechercher une borne..." oninput="filterStations()" style="display: none;">
                            <select id="stationId" name="stationId" required onchange="updateStationInfo()" class="form-select">
                                <option value="">S√©lectionnez une borne...</option>
                            </select>
                            <a th:href="@{/map}" class="find-station-link">Trouver une borne</a>
                        </div>
                    </div>
                    
                        <div id="stationInfo" class="card bg-light mb-3" style="display: none;">
                            <div class="card-body">
                                <h5 class="card-title">Informations de la borne</h5>
                                <div class="row g-2">
                                    <div class="col-md-6">
                                        <strong>Type de prise:</strong> <span id="stationPlugType">-</span>
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Tarif horaire:</strong> <span id="stationHourlyRate">-</span>
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Lieu:</strong> <span id="stationLocation">-</span>
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Statut:</strong> <span id="stationStatus">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Quand ?</label>
                        <div class="row g-2">
                            <div class="col-md-6">
                                <label for="startDate" class="form-label">Date d√©but</label>
                                <input type="date" id="startDate" name="startDate" class="form-control" required onchange="calculatePrice()">
                            </div>
                            <div class="col-md-6">
                                <label for="startTime" class="form-label">Heure d√©but</label>
                                <input type="time" id="startTime" name="startTime" class="form-control" required onchange="calculatePrice()">
                            </div>
                            <div class="col-md-6">
                                <label for="endDate" class="form-label">Date fin</label>
                                <input type="date" id="endDate" name="endDate" class="form-control" required onchange="calculatePrice()">
                            </div>
                            <div class="col-md-6">
                                <label for="endTime" class="form-label">Heure de fin</label>
                                <input type="time" id="endTime" name="endTime" class="form-control" required onchange="calculatePrice()">
                            </div>
                        </div>
                    </div>
                    
                        <div id="priceCalculation" class="card bg-primary text-white mb-3" style="display: none;">
                        <h5>Montant √† r√©gler</h5>
                        <div class="price-breakdown">
                            <span>Dur√©e:</span>
                            <span id="duration">-</span>
                        </div>
                        <div class="price-breakdown">
                            <span>Tarif horaire:</span>
                            <span id="hourlyRate">-</span>
                        </div>
                        <div class="total-price">
                            <span>Montant √† r√©gler:</span>
                            <span id="totalPrice">-</span>
                        </div>
                    </div>
                    
                    <div class="payment-section">
                        <h4>Informations de paiement</h4>
                        
                        <div class="mb-3" style="max-width: 600px;">
                            <label for="cardNumber" class="form-label">Num√©ro de la carte bancaire</label>
                            <input type="text" id="cardNumber" name="cardNumber" class="form-control" placeholder="1234 5678 9012 3456" maxlength="19" required>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="expiryMonth" class="form-label">Mois d'expiration</label>
                                <select id="expiryMonth" name="expiryMonth" class="form-select" required>
                                    <option value="">Mois</option>
                                    <option value="01">Janvier</option>
                                    <option value="02">F√©vrier</option>
                                    <option value="03">Mars</option>
                                    <option value="04">Avril</option>
                                    <option value="05">Mai</option>
                                    <option value="06">Juin</option>
                                    <option value="07">Juillet</option>
                                    <option value="08">Ao√ªt</option>
                                    <option value="09">Septembre</option>
                                    <option value="10">Octobre</option>
                                    <option value="11">Novembre</option>
                                    <option value="12">D√©cembre</option>
                                </select>
                            </div>
                            
                            <div class="col-md-4">
                                <label for="expiryYear" class="form-label">Ann√©e d'expiration</label>
                                <select id="expiryYear" name="expiryYear" class="form-select" required>
                                    <option value="">Ann√©e</option>
                                </select>
                            </div>
                            
                            <div class="col-md-4">
                                <label for="cvv" class="form-label">CVV</label>
                                <input type="text" id="cvv" name="cvv" class="form-control" placeholder="123" maxlength="4" required>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: left;">
                        <button type="submit" class="btn btn-primary btn-lg" style="min-width: 200px; max-width: 400px;">R√©server</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script th:src="@{/js/config.js}"></script>
    <!-- jwt-utils.js charg√© explicitement ici car n√©cessaire avant le script inline -->
    <script th:src="@{/js/jwt-utils.js}"></script>
    <script th:src="@{/js/auth.js}"></script>
    <script>
        // Fonction pour r√©cup√©rer l'ID utilisateur actuel (dynamique)
        function getCurrentUserIdDynamic() {
            const user = getAuthUser();
            if (!user || !user.id) {
                console.error('Erreur d\'authentification: utilisateur non trouv√©');
                window.location.href = '/login';
                return null;
            }
            return user.id;
        }
        
        let stations = [];
        let locations = [];
        
        // Fonction pour initialiser la page apr√®s v√©rification d'authentification
        function loadReservationData() {
            // V√©rifier l'authentification au chargement
            const currentUserId = getCurrentUserIdDynamic();
            if (!currentUserId) {
                return; // Redirection d√©j√† faite dans getCurrentUserIdDynamic
            }
            
            setMinDate();
            populateExpiryYears();
            setupCardNumberFormatting();
            const params = new URLSearchParams(window.location.search);
            const preselectId = params.get('stationId');
            loadData().then(() => {
                if (preselectId) {
                    const select = document.getElementById('stationId');
                    const option = select.querySelector(`option[value="${preselectId}"]`);
                    if (option) {
                        // La station est disponible, la s√©lectionner
                        select.value = preselectId;
                        updateStationInfo();
                    } else {
                        // La station n'est pas disponible (probablement appartient √† l'utilisateur)
                        const station = stations.find(s => s.id == preselectId);
                        if (station) {
                            const location = locations.find(loc => loc.id === station.locationId);
                            if (location && location.ownerId === getCurrentUserIdDynamic()) {
                                showError('Vous ne pouvez pas r√©server votre propre borne. Veuillez s√©lectionner une autre borne.');
                            } else {
                                showError('Cette borne n\'est pas disponible pour r√©servation.');
                            }
                        } else {
                            showError('Borne introuvable.');
                        }
                    }
                }
            });
        }
        
        function setMinDate() {
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            document.getElementById('startDate').min = today;
            document.getElementById('endDate').min = today;
        }
        
        function populateExpiryYears() {
            const yearSelect = document.getElementById('expiryYear');
            const currentYear = new Date().getFullYear();
            
            for (let i = 0; i < 10; i++) {
                const year = currentYear + i;
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            }
        }
        
        function setupCardNumberFormatting() {
            const cardInput = document.getElementById('cardNumber');
            cardInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\s/g, '').replace(/[^0-9]/gi, '');
                let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
                e.target.value = formattedValue;
            });
        }
        
        function filterStations() {
            // Fonction pour filtrer les stations (√† impl√©menter si n√©cessaire)
        }
        
        async function loadData() {
            try {
                showLoading(true);
                
                console.log('üîÑ Chargement des stations et lieux...');
                console.log('üîß API_BASE_URL:', API_BASE_URL);
                
                // Utiliser authenticatedFetch pour envoyer le token JWT
                const [stationsResponse, locationsResponse] = await Promise.all([
                    authenticatedFetch(API_BASE_URL + '/api/stations?size=1000', {
                        method: 'GET',
                        credentials: 'include'
                    }),
                    authenticatedFetch(API_BASE_URL + '/api/locations?size=1000', {
                        method: 'GET',
                        credentials: 'include'
                    })
                ]);
                
                console.log('üì° Stations response status:', stationsResponse.status);
                console.log('üì° Locations response status:', locationsResponse.status);
                
                if (!stationsResponse.ok) {
                    const errorText = await stationsResponse.text();
                    console.error('‚ùå Erreur stations:', stationsResponse.status, errorText);
                    throw new Error('Erreur lors du chargement des bornes (status: ' + stationsResponse.status + ')');
                }
                
                if (!locationsResponse.ok) {
                    const errorText = await locationsResponse.text();
                    console.error('‚ùå Erreur locations:', locationsResponse.status, errorText);
                    throw new Error('Erreur lors du chargement des lieux (status: ' + locationsResponse.status + ')');
                }
                
                const stationsData = await stationsResponse.json();
                const locationsData = await locationsResponse.json();
                
                console.log('üì¶ Stations data:', stationsData);
                console.log('üì¶ Locations data:', locationsData);
                
                // G√©rer la pagination (Spring Data retourne {content: [...], totalElements: ...})
                stations = Array.isArray(stationsData) ? stationsData : (stationsData.content || []);
                locations = Array.isArray(locationsData) ? locationsData : (locationsData.content || []);
                
                console.log('‚úÖ Stations charg√©es:', stations.length);
                console.log('‚úÖ Lieux charg√©s:', locations.length);
                
                if (stations.length === 0) {
                    console.warn('‚ö†Ô∏è Aucune station trouv√©e');
                }
                
                populateStationSelect();
                showLoading(false);
                
            } catch (error) {
                console.error('‚ùå Erreur loadData:', error);
                showError('Erreur lors du chargement: ' + error.message);
                showLoading(false);
            }
        }
        
        function populateStationSelect() {
            const select = document.getElementById('stationId');
            select.innerHTML = '<option value="">S√©lectionnez une borne...</option>';
            
            if (!Array.isArray(stations)) {
                showError('Erreur: Les donn√©es des bornes sont invalides');
                return;
            }
            
            if (!Array.isArray(locations)) {
                showError('Erreur: Les donn√©es des lieux sont invalides');
                return;
            }
            
            // R√©cup√©rer l'ID utilisateur actuel (dynamique, au moment du filtrage)
            const currentUserId = getCurrentUserIdDynamic();
            if (!currentUserId) {
                return; // Redirection d√©j√† faite
            }
            
            // Filtrer les stations actives ET qui n'appartiennent pas √† l'utilisateur
            const activeStations = stations.filter(station => {
                // V√©rifier que la station existe et a les propri√©t√©s n√©cessaires
                if (!station || !station.id) return false;
                
                // V√©rifier le statut (peut √™tre isActive ou status)
                const isActive = station.isActive !== undefined ? station.isActive : 
                                (station.status === 'ACTIVE' || station.status === 'active');
                if (!isActive) return false;
                
                // Exclure les propres stations de l'utilisateur
                const location = locations.find(loc => loc.id === station.locationId);
                if (location && location.ownerId === currentUserId) {
                    return false; // Ne pas afficher ses propres stations
                }
                
                return true;
            });
            
            console.log('üîç Stations filtr√©es (actives et non-propri√©taires):', activeStations.length);
            
            if (activeStations.length === 0) {
                showError('Aucune borne disponible pour r√©servation. Vous ne pouvez pas r√©server vos propres bornes.');
                document.getElementById('formContainer').style.display = 'block';
                return;
            }
            
            activeStations.forEach(station => {
                const location = locations.find(loc => loc.id === station.locationId);
                const locationName = location ? location.label : 'Lieu inconnu';
                
                const option = document.createElement('option');
                option.value = station.id;
                
                let optionText = '';
                if (station.name) {
                    optionText += station.name;
                } else {
                    optionText += 'Borne sans nom';
                }
                
                optionText += ' - ';
                optionText += locationName;
                optionText += ' (';
                
                if (station.hourlyRate !== undefined && station.hourlyRate !== null) {
                    optionText += station.hourlyRate;
                } else {
                    optionText += '0.00';
                }
                
                optionText += '‚Ç¨/h)';
                
                option.textContent = optionText;
                option.dataset.station = JSON.stringify(station);
                select.appendChild(option);
            });
            
            document.getElementById('formContainer').style.display = 'block';
        }
        
        function updateStationInfo() {
            const select = document.getElementById('stationId');
            if (!select || !select.options || select.selectedIndex < 0) {
                document.getElementById('stationInfo').style.display = 'none';
                document.getElementById('priceCalculation').style.display = 'none';
                return;
            }
            
            const selectedOption = select.options[select.selectedIndex];
            
            if (selectedOption && selectedOption.value && selectedOption.dataset && selectedOption.dataset.station) {
                try {
                    const station = JSON.parse(selectedOption.dataset.station);
                    const location = locations.find(loc => loc.id === station.locationId);
                    
                    document.getElementById('stationPlugType').textContent = station.plugType || '-';
                    document.getElementById('stationHourlyRate').textContent = `${station.hourlyRate || '0.00'} ‚Ç¨/h`;
                    document.getElementById('stationLocation').textContent = location ? location.label : 'Lieu inconnu';
                    document.getElementById('stationStatus').textContent = station.isActive ? 'Active' : 'Inactive';
                    
                    document.getElementById('stationInfo').style.display = 'block';
                    calculatePrice();
                } catch (e) {
                    console.error('Erreur lors de la mise √† jour des infos de la station:', e);
                    document.getElementById('stationInfo').style.display = 'none';
                    document.getElementById('priceCalculation').style.display = 'none';
                }
            } else {
                document.getElementById('stationInfo').style.display = 'none';
                document.getElementById('priceCalculation').style.display = 'none';
            }
        }
        
        function calculatePrice() {
            const startDate = document.getElementById('startDate').value;
            const startTime = document.getElementById('startTime').value;
            const endDate = document.getElementById('endDate').value;
            const endTime = document.getElementById('endTime').value;
            const stationId = document.getElementById('stationId').value;
            
            if (!startDate || !startTime || !endDate || !endTime || !stationId) {
                document.getElementById('priceCalculation').style.display = 'none';
                return;
            }
            
            const start = new Date(startDate + 'T' + startTime);
            const end = new Date(endDate + 'T' + endTime);
            
            if (end <= start) {
                document.getElementById('priceCalculation').style.display = 'none';
                return;
            }
            
            const station = stations.find(s => s.id == stationId);
            
            if (!station) {
                return;
            }
            
            const durationMs = end - start;
            const durationHours = durationMs / (1000 * 60 * 60);
            const totalPrice = durationHours * station.hourlyRate;
            
            document.getElementById('duration').textContent = durationHours.toFixed(2) + ' heures';
            document.getElementById('hourlyRate').textContent = station.hourlyRate + ' ‚Ç¨/h';
            document.getElementById('totalPrice').textContent = totalPrice.toFixed(2) + ' ‚Ç¨';
            
            document.getElementById('priceCalculation').style.display = 'block';
        }
        
        function setupFormSubmit() {
            const form = document.getElementById('reservationForm');
            if (!form) {
                console.error('Formulaire de r√©servation non trouv√©');
                return;
            }
            
            form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            
            // Combiner date et heure
            const startDate = formData.get('startDate');
            const startTime = formData.get('startTime');
            const endDate = formData.get('endDate');
            const endTime = formData.get('endTime');
            
            const startDateTime = startDate + 'T' + startTime + ':00.000';
            const endDateTime = endDate + 'T' + endTime + ':00.000';
            
            const reservationData = {
                stationId: parseInt(formData.get('stationId')),
                startTime: startDateTime,
                endTime: endDateTime
            };
            
            // Validation des informations de paiement
            const cardNumber = formData.get('cardNumber');
            const expiryMonth = formData.get('expiryMonth');
            const expiryYear = formData.get('expiryYear');
            const cvv = formData.get('cvv');
            
            if (!cardNumber || !expiryMonth || !expiryYear || !cvv) {
                showError('Veuillez remplir toutes les informations de paiement');
                return;
            }
            
            // Validation basique du num√©ro de carte (16 chiffres)
            const cleanCardNumber = cardNumber.replace(/\s/g, '');
            if (cleanCardNumber.length !== 16 || !/^\d+$/.test(cleanCardNumber)) {
                showError('Le num√©ro de carte doit contenir 16 chiffres');
                return;
            }
            
            // Validation du CVV (3 ou 4 chiffres)
            if (!/^\d{3,4}$/.test(cvv)) {
                showError('Le CVV doit contenir 3 ou 4 chiffres');
                return;
            }
            
            // Validation c√¥t√© client
            if (!reservationData.stationId || !reservationData.startTime || !reservationData.endTime) {
                showError('Veuillez remplir tous les champs obligatoires');
                return;
            }
            
            const start = new Date(reservationData.startTime);
            const end = new Date(reservationData.endTime);
            
            if (end <= start) {
                showError('L\'heure de fin doit √™tre post√©rieure √† l\'heure de d√©but');
                return;
            }
            
            if (start < new Date()) {
                showError('La r√©servation ne peut pas √™tre dans le pass√©');
                return;
            }
            
            try {
                showLoading(true);
                
                // Utiliser l'API authentifi√©e (l'userId est extrait du token JWT)
                const response = await authenticatedFetch(API_BASE_URL + '/api/reservations', {
                    method: 'POST',
                    body: JSON.stringify(reservationData)
                });
                
                if (!response.ok) {
                    let errorMessage = 'Erreur lors de la cr√©ation de la r√©servation';
                    const errorText = await response.text();
                    try {
                        const errorData = JSON.parse(errorText);
                        errorMessage = errorData.message || errorData || errorMessage;
                    } catch (e) {
                        errorMessage = errorText || errorMessage;
                    }
                    throw new Error(errorMessage);
                }
                
                showSuccess('R√©servation cr√©√©e avec succ√®s !');
                setTimeout(() => {
                    window.location.href = '/reservations';
                }, 2000);
                
            } catch (error) {
                showError('Erreur lors de la cr√©ation: ' + error.message);
                showLoading(false);
            }
            });
        }
        
        function showLoading(show) {
            document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
            document.getElementById('formContainer').style.display = show ? 'none' : 'block';
            
            if (show) {
                const submitBtn = document.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.innerHTML = 'Cr√©ation en cours...';
                    submitBtn.disabled = true;
                }
            } else {
                const submitBtn = document.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.innerHTML = 'R√©server';
                    submitBtn.disabled = false;
                }
            }
        }
        
        function showError(message) {
            const container = document.getElementById('messageContainer');
            container.innerHTML = '<div class="error">' + message + '</div>';
        }
        
        function showSuccess(message) {
            const container = document.getElementById('messageContainer');
            container.innerHTML = '<div class="success">' + message + '</div>';
        }
        
        // Initialiser la page une fois que le DOM est charg√©
        // jwt-utils.js est charg√© juste avant, donc requireAuth sera disponible
        function initPage() {
            // V√©rifier l'authentification IMM√âDIATEMENT et de mani√®re STRICTE
            // Si l'utilisateur n'est pas connect√©, rediriger vers login AVANT tout
            
            // Utiliser requireAuth() qui est la fonction la plus fiable (v√©rifie token ET user)
            if (typeof requireAuth === 'function') {
                // requireAuth() redirige automatiquement vers /login si non authentifi√©
                if (!requireAuth()) {
                    // requireAuth() a d√©j√† redirig√©, on sort
                    return;
                }
                // Si on arrive ici, requireAuth() a retourn√© true, l'utilisateur est authentifi√©
            } else {
                // Fallback si requireAuth n'est pas disponible : v√©rification manuelle stricte
                let userIsAuthenticated = false;
                
                // V√©rification stricte : l'utilisateur doit avoir des donn√©es utilisateur valides avec un ID
                if (typeof getAuthUser === 'function') {
                    const user = getAuthUser();
                    // V√©rifier que l'utilisateur existe et a un ID valide (nombre)
                    if (user && user.id && typeof user.id === 'number') {
                        userIsAuthenticated = true;
                    }
                }
                
                // Fallback : utiliser isAuthenticated() si disponible
                if (!userIsAuthenticated && typeof isAuthenticated === 'function') {
                    userIsAuthenticated = isAuthenticated();
                }
                
                // Si pas authentifi√©, rediriger imm√©diatement
                if (!userIsAuthenticated) {
                    window.location.href = '/login';
                    return;
                }
            }
            
            // Si on arrive ici, l'utilisateur est authentifi√©
            // Configurer le formulaire
            setupFormSubmit();
            
            // Charger les donn√©es de r√©servation
            loadReservationData();
        }
        
        // S'assurer que le DOM est charg√© ET que les scripts sont charg√©s avant d'initialiser
        function waitForScriptsAndInit() {
            // V√©rifier que authenticatedFetch est disponible
            if (typeof authenticatedFetch === 'function') {
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', initPage);
                } else {
                    initPage();
                }
            } else {
                // R√©essayer apr√®s un court d√©lai si les scripts ne sont pas encore charg√©s
                console.log('‚è≥ En attente du chargement de jwt-utils.js...');
                setTimeout(waitForScriptsAndInit, 100);
            }
        }
        
        // D√©marrer l'attente
        waitForScriptsAndInit();
    </script>
    <th:block th:replace="~{includes/navbar :: scripts-bootstrap}"></th:block>
    <div th:replace="~{includes/navbar :: navbar-script}"></div>
</body>
</html>





